<?xml version="1.0" encoding="utf-8"?>
<mdscript name="FactionLogic_Enhanced_Tasks" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../xsd/md.xsd">
  <cues>
    <cue name="LuaEvents_Instanced" instantiate="true">
      <conditions>
        <check_any>
          <event_ui_triggered screen="'OneSector'" control="'setProductionDemandOutput'" /> <!-- param3 = table[products[ware, value], resources[ware, value]] -->
        </check_any>
      </conditions>
      <actions>
        <!-- receive table of production modules' production capabilities and demands -->
        <do_if value="event.param2 == 'setProductionDemandOutput'">
          <set_value name="global.$EnhancedLogic.$ProductionDemandOutput" exact="event.param3" />
        </do_if>
      </actions>
    </cue>

    <cue name="Update_Ships" instantiate="true">
      <conditions>
        <check_any>
          <check_all>
            <event_object_destroyed />
            <check_value value="event.object.isclass.ship" />
            <check_value value="event.object.primarypurpose == purpose.trade or event.object.primarypurpose == purpose.mine" />
            <check_value value="global.$FactionManagers.{event.object.trueowner}.exists" />
          </check_all>
          <check_all>
            <event_object_changed_true_owner />
            <check_value value="event.object.isclass.ship" />
            <check_value value="event.object.primarypurpose == purpose.trade or event.object.primarypurpose == purpose.mine" />
            <check_any>
              <check_value value="global.$FactionManagers.{event.param}.exists" />
              <check_value value="global.$FactionManagers.{event.param2}.exists" />
            </check_any>
          </check_all>
        </check_any>
      </conditions>
      <delay exact="1ms" />
      <actions>
        <do_if value="event.name == 'event_object_destroyed'">
          <set_value name="$LosingFaction" exact="event.object.trueowner" />
        </do_if>
        <do_elseif value="event.name == 'event_object_changed_true_owner'">
          <do_if value="global.$FactionManagers.{event.param}.exists">
            <set_value name="$GainingFaction" exact="event.param" />
          </do_if>
          <do_if value="@$GainingFaction">
            <!-- add to lists -->
            <run_actions ref="UpdateShip">
              <param name="Faction" value="$GainingFaction" />
              <param name="ship" value="event.object" />
              <param name="purpose" value="event.object.primarypurpose" />
            </run_actions>
          </do_if>
          <do_if value="global.$FactionManagers.{event.param2}.exists">
            <set_value name="$LosingFaction" exact="event.param2" />
          </do_if>
        </do_elseif>
        <do_if value="@$LosingFaction">
          <run_actions ref="UpdateShip">
            <param name="Faction" value="$LosingFaction" />
            <param name="ship" value="event.object" />
            <param name="purpose" value="event.object.primarypurpose" />
            <param name="remove" value="true" />
          </run_actions>
        </do_if>
      </actions>
    </cue>
    <library name="UpdateShip" purpose="run_actions">
      <params>
        <param name="Faction" />
        <param name="ship" />
        <param name="purpose" />
        <param name="remove" default="false" />
      </params>
      <actions>
        <set_value name="$Manager" exact="global.$FactionManagers.{$Faction}" />
        <set_value name="$Enhanced_Ships" exact="$Manager.$Enhanced_Ships" />
        <include_actions ref="md.FactionLogic_Enhanced.Process_Ship" />
      </actions>
    </library>
    <!-- end Update_Ships -->

    <cue name="Process_Sector" instantiate="true">
      <conditions>
        <event_contained_sector_changed_owner space="player.galaxy" />
      </conditions>
      <delay exact="1ms" />
      <actions>
        <set_value name="$sector" exact="event.param" />
        <set_value name="$LosingFaction" exact="event.param3" />
        <do_if value="@global.$FactionManagers.{$LosingFaction}">
          <set_value name="$Manager" exact="global.$FactionManagers.{$LosingFaction}" />
          <do_if value="$Manager.$Enhanced_Sectors.$Enhanced_PrimeSectors.indexof.{$sector}">
            <remove_from_group group="$Manager.$Enhanced_Sectors" object="$sector" />
          </do_if>
        </do_if>
        <do_elseif value="$LosingFaction == faction.ownerless and @global.$EnhancedLogic.$NeutralZones.indexof.{$sector}">
          <remove_from_group group="global.$EnhancedLogic.$NeutralZones" object="$sector" />
        </do_elseif>
        <set_value name="$Faction" exact="event.param2" />
        <include_actions ref="md.FactionLogic_Enhanced.Process_Sector" />
        <cancel_cue cue="this" />
      </actions>
    </cue>
    <!-- end Update_Sectors -->

    <cue name="Update_Stations" instantiate="true">
      <conditions>
        <check_any>
          <check_all>
            <event_build_finished />
            <check_value value="event.param3.buildobject.canbuildships" />
            <check_value value="global.$FactionManagers.{event.param3.buildobject.trueowner}.exists" />
          </check_all>
          <check_all>
            <event_object_destroyed />
            <check_value value="event.object.canbuildships" />
            <check_value value="global.$FactionManagers.{event.object.trueowner}.exists" />
          </check_all>
          <check_all>
            <event_object_changed_true_owner />
            <check_value value="event.object.canbuildships" />
            <check_any>
              <check_value value="global.$FactionManagers.{event.param}.exists" />
              <check_value value="global.$FactionManagers.{event.param2}.exists" />
            </check_any>
          </check_all>
        </check_any>
      </conditions>
      <delay exact="1ms" />
      <actions>
        <do_if value="event.name == 'event_object_changed_true_owner'">
          <!-- enhanced todo: Update_Stations event_object_changed_true_owner -->
        </do_if>
        <do_else>
          <do_if value="event.name == 'event_build_finished'">
            <set_value name="$station" exact="event.param3.buildobject" />
          </do_if>
          <do_elseif value="event.name == 'event_object_destroyed'">
            <set_value name="$station" exact="event.object" />
            <set_value name="$remove" exact="true" />
          </do_elseif>
          <run_actions ref="UpdateStation">
            <param name="station" value="$station" />
            <param name="remove" value="@$remove" />
          </run_actions>
        </do_else>
      </actions>
    </cue>
    <library name="UpdateStation" purpose="run_actions">
      <params>
        <param name="station" />
        <param name="remove" default="false" />
      </params>
      <actions>
        <set_value name="$Faction" exact="$station.trueowner" />
        <set_value name="$Manager" exact="global.$FactionManagers.{$Faction}" />
        <include_actions ref="Process_Station" />
      </actions>
    </library>
  </cues>
</mdscript>